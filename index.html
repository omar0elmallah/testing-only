<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevHub - منصة المطورين العربية</title>
    <meta name="description" content="منصة عربية متكاملة للمطورين والمبرمجين للتواصل، مشاركة المشاريع، كتابة المقالات والتعاون">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/4.0.0/firebaseui.css" />
    <style>
        /* جميع أنماط CSS السابقة */
        /* تم اختصارها للتركيز على الوظائف */
    </style>
</head>
<body>
    <!-- صفحة المصادقة -->
    <div id="auth-page" class="auth-container">
        <!-- محتوى المصادقة -->
    </div>

    <!-- لوحة التحكم -->
    <div id="dashboard" class="container hidden">
        <!-- الشريط الجانبي -->
        <div class="sidebar">
            <!-- عناصر القائمة -->
        </div>
        
        <!-- المحتوى الرئيسي -->
        <div class="main-content">
            <!-- تبويبات المحتوى -->
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://cdn.firebase.com/libs/firebaseui/4.0.0/firebaseui.js"></script>
    <script>
        // التهيئة الكاملة للتطبيق
        const firebaseConfig = {
            apiKey: "AIzaSyBfXJ-2tmCYo-pQjfN_4nAdxC-NcqfjAlo",
            authDomain: "tamec-8f9ea.firebaseapp.com",
            projectId: "tamec-8f9ea",
            storageBucket: "tamec-8f9ea.appspot.com",
            messagingSenderId: "372610375354",
            appId: "1:372610375354:web:1beaff9695e7b49cdeec83"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const functions = firebase.functions();

        // متغيرات التطبيق
        let currentUser = null;
        let userData = {};
        let posts = [];
        let articles = [];
        let requests = [];
        let githubRepos = [];

        // عناصر DOM
        const authPage = document.getElementById('auth-page');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const logoutBtn = document.getElementById('logout-btn');
        const userAvatar = document.getElementById('user-avatar');
        const menuItems = document.querySelectorAll('.menu-item');
        const tabContents = document.querySelectorAll('.tab-content');
        const pageTitle = document.getElementById('page-title');
        const darkModeToggle = document.getElementById('dark-mode-toggle');

        // تهيئة التطبيق
        function initApp() {
            setupEventListeners();
            checkAuthState();
            setupDarkMode();
        }

        // إعداد معالجات الأحداث
        function setupEventListeners() {
            // تسجيل الدخول
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        loadUserData(userCredential.user.uid);
                    })
                    .catch((error) => {
                        showAlert('error', error.message);
                    });
            });

            // تسجيل الخروج
            logoutBtn.addEventListener('click', () => {
                auth.signOut();
            });

            // تغيير وضع الظلام
            darkModeToggle.addEventListener('change', () => {
                document.body.classList.toggle('dark-mode', darkModeToggle.checked);
                localStorage.setItem('darkMode', darkModeToggle.checked);
            });

            // متابعة تغيير حالة المصادقة
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    authPage.classList.add('hidden');
                    dashboard.classList.remove('hidden');
                    loadUserData(user.uid);
                    loadInitialData();
                } else {
                    currentUser = null;
                    authPage.classList.remove('hidden');
                    dashboard.classList.add('hidden');
                }
            });
        }

        // تحميل بيانات المستخدم
        async function loadUserData(userId) {
            try {
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists) {
                    userData = doc.data();
                    updateUserProfile();
                } else {
                    // إنشاء ملف تعريف جديد إذا لم يكن موجودًا
                    await createUserProfile(userId);
                }
            } catch (error) {
                showAlert('error', 'حدث خطأ في تحميل بيانات المستخدم');
            }
        }

        // إنشاء ملف تعريف جديد
        async function createUserProfile(userId) {
            try {
                const user = auth.currentUser;
                const userObj = {
                    uid: userId,
                    displayName: user.displayName || user.email.split('@')[0],
                    email: user.email,
                    photoURL: user.photoURL || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    skills: [],
                    bio: '',
                    githubUsername: ''
                };

                await db.collection('users').doc(userId).set(userObj);
                userData = userObj;
                updateUserProfile();
            } catch (error) {
                showAlert('error', 'حدث خطأ في إنشاء ملف التعريف');
            }
        }

        // تحديث واجهة ملف المستخدم
        function updateUserProfile() {
            // تحديث الصورة
            if (userData.photoURL) {
                document.querySelectorAll('.user-avatar, .profile-avatar').forEach(el => {
                    el.style.backgroundImage = `url(${userData.photoURL})`;
                    el.textContent = '';
                });
            } else {
                document.querySelectorAll('.user-avatar, .profile-avatar').forEach(el => {
                    el.textContent = userData.displayName.charAt(0).toUpperCase();
                });
            }

            // تحديث الاسم
            document.getElementById('profile-name').textContent = userData.displayName;
            
            // تحديث البريد الإلكتروني
            document.getElementById('user-email').textContent = userData.email;
            
            // تحديث السيرة الذاتية إذا وجدت
            if (userData.bio) {
                document.getElementById('profile-bio').textContent = userData.bio;
            }
        }

        // تحميل البيانات الأولية
        async function loadInitialData() {
            try {
                await loadPosts();
                await loadArticles();
                await loadWebRequests();
                if (userData.githubUsername) {
                    await loadGithubRepos();
                }
            } catch (error) {
                showAlert('error', 'حدث خطأ في تحميل البيانات الأولية');
            }
        }

        // تحميل المنشورات
        async function loadPosts() {
            try {
                const snapshot = await db.collection('posts')
                    .orderBy('createdAt', 'desc')
                    .limit(20)
                    .get();
                
                posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPosts();
            } catch (error) {
                throw error;
            }
        }

        // عرض المنشورات
        function renderPosts() {
            const postsContainer = document.getElementById('posts-list');
            if (!postsContainer) return;
            
            postsContainer.innerHTML = '';
            
            posts.forEach(post => {
                const postElement = createPostElement(post);
                postsContainer.appendChild(postElement);
            });
        }

        // إنشاء عنصر منشور
        function createPostElement(post) {
            const postElement = document.createElement('div');
            postElement.className = 'post';
            postElement.dataset.id = post.id;
            
            // بناء محتوى المنشور
            let contentHTML = `
                <div class="post-header">
                    <img src="${post.authorPhoto || 'https://via.placeholder.com/40'}" alt="User Avatar">
                    <div class="post-user">
                        <h4>${post.authorName}</h4>
                        <span>${formatDate(post.createdAt)}</span>
                    </div>
                    ${post.userId === currentUser.uid ? 
                        `<div class="post-menu" data-id="${post.id}">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>` : ''}
                </div>
                <div class="post-content">
                    <p>${post.content}</p>
            `;
            
            // إضافة صورة إذا وجدت
            if (post.imageUrl) {
                contentHTML += `<img src="${post.imageUrl}" alt="Post Image" class="post-image">`;
            }
            
            // إضافة كود إذا وجد
            if (post.code) {
                contentHTML += `
                    <div class="post-code">
                        <button class="post-code-copy" onclick="copyCode('${post.id}')">
                            <i class="far fa-copy"></i> نسخ
                        </button>
                        <pre><code>${post.code}</code></pre>
                    </div>
                `;
            }
            
            // تذييل المنشور
            contentHTML += `
                </div>
                <div class="post-footer">
                    <div class="post-like" data-id="${post.id}">
                        <i class="far fa-heart ${post.likes?.includes(currentUser.uid) ? 'active' : ''}"></i>
                        <span>${post.likes?.length || 0} إعجاب</span>
                    </div>
                    <div class="post-comment" data-id="${post.id}">
                        <i class="far fa-comment"></i>
                        <span>${post.comments?.length || 0} تعليق</span>
                    </div>
                    <div class="post-share" data-id="${post.id}">
                        <i class="fas fa-share"></i>
                        <span>مشاركة</span>
                    </div>
                </div>
                <div class="post-comments" id="comments-${post.id}"></div>
            `;
            
            postElement.innerHTML = contentHTML;
            return postElement;
        }

        // تحميل المقالات
        async function loadArticles() {
            try {
                const snapshot = await db.collection('articles')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();
                
                articles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderArticles();
            } catch (error) {
                throw error;
            }
        }

        // عرض المقالات
        function renderArticles() {
            // عرض المقالات في الصفحة الرئيسية
            const homeArticles = document.getElementById('home-articles');
            if (homeArticles) {
                homeArticles.innerHTML = articles.slice(0, 3).map(article => 
                    createArticleCard(article)
                ).join('');
            }
            
            // عرض جميع المقالات
            const allArticles = document.getElementById('all-articles');
            if (allArticles) {
                allArticles.innerHTML = articles.map(article => 
                    createArticleCard(article)
                ).join('');
            }
        }

        // إنشاء بطاقة مقال
        function createArticleCard(article) {
            return `
                <div class="article-card" data-id="${article.id}">
                    <img src="${article.imageUrl || 'https://via.placeholder.com/400x225'}" 
                         alt="${article.title}" class="article-image">
                    <div class="article-content">
                        <span class="article-category">${article.category || 'برمجة'}</span>
                        <h3 class="article-title">${article.title}</h3>
                        <p class="article-excerpt">${article.excerpt || ''}</p>
                        <div class="article-meta">
                            <span>${formatDate(article.createdAt)}</span>
                            <span class="article-author">${article.authorName}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // تحميل طلبات الويب
        async function loadWebRequests() {
            try {
                const snapshot = await db.collection('webRequests')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderWebRequests();
            } catch (error) {
                throw error;
            }
        }

        // عرض طلبات الويب
        function renderWebRequests() {
            const requestsContainer = document.getElementById('user-requests');
            if (!requestsContainer) return;
            
            requestsContainer.innerHTML = '<h2>طلباتي السابقة</h2>';
            
            if (requests.length === 0) {
                requestsContainer.innerHTML += '<p>لا توجد طلبات سابقة</p>';
                return;
            }
            
            requests.forEach(request => {
                const statusClass = `status-${request.status.replace(' ', '-')}`;
                const statusText = getStatusText(request.status);
                const formattedDate = formatDate(request.createdAt);
                
                const requestElement = document.createElement('div');
                requestElement.className = 'request-item';
                requestElement.innerHTML = `
                    <div class="request-header">
                        <h3 class="request-title">${request.projectName}</h3>
                        <span class="request-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="request-meta">
                        <span>تم الإنشاء: ${formattedDate}</span>
                        ${request.projectBudget ? `<span>الميزانية: ${request.projectBudget}</span>` : ''}
                    </div>
                    <div class="request-description">
                        <p>${request.projectDescription}</p>
                    </div>
                    <div class="request-actions">
                        <button class="action-btn view-btn" data-id="${request.id}">عرض التفاصيل</button>
                        ${request.status === 'pending' ? 
                            `<button class="action-btn delete-btn" data-id="${request.id}">حذف</button>` : ''}
                    </div>
                `;
                
                requestsContainer.appendChild(requestElement);
            });
        }

        // تحميل مستودعات GitHub
        async function loadGithubRepos() {
            try {
                if (!userData.githubUsername) return;
                
                const response = await fetch(`https://api.github.com/users/${userData.githubUsername}/repos`);
                if (!response.ok) throw new Error('Failed to fetch GitHub repos');
                
                githubRepos = await response.json();
                renderGithubRepos();
            } catch (error) {
                throw error;
            }
        }

        // عرض مستودعات GitHub
        function renderGithubRepos() {
            const reposContainer = document.getElementById('github-repos');
            if (!reposContainer) return;
            
            reposContainer.innerHTML = '';
            
            if (githubRepos.length === 0) {
                reposContainer.innerHTML = '<p>لا توجد مستودعات متاحة</p>';
                return;
            }
            
            githubRepos.slice(0, 5).forEach(repo => {
                const repoElement = document.createElement('div');
                repoElement.className = 'repo-item';
                repoElement.innerHTML = `
                    <div class="repo-header">
                        <h4>
                            <a href="${repo.html_url}" target="_blank">
                                <i class="fab fa-github"></i> ${repo.name}
                            </a>
                        </h4>
                        <span class="repo-meta">
                            <i class="fas fa-star"></i> ${repo.stargazers_count}
                            <i class="fas fa-code-branch"></i> ${repo.forks_count}
                        </span>
                    </div>
                    <p class="repo-description">${repo.description || 'لا يوجد وصف'}</p>
                    <div class="repo-footer">
                        <span class="repo-language">${repo.language || 'غير معروف'}</span>
                        <span class="repo-updated">آخر تحديث: ${formatDate(new Date(repo.updated_at))}</span>
                    </div>
                `;
                
                reposContainer.appendChild(repoElement);
            });
        }

        // وظائف مساعدة
        function formatDate(date) {
            if (!date) return '';
            if (date.toDate) date = date.toDate();
            return date.toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'قيد المراجعة',
                'in-progress': 'قيد التنفيذ',
                'completed': 'مكتمل'
            };
            return statusMap[status] || status;
        }

        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function setupDarkMode() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            document.body.classList.toggle('dark-mode', darkMode);
            darkModeToggle.checked = darkMode;
        }

        // تهيئة التطبيق عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
